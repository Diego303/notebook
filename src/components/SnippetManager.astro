---
---
<div class="snippets-container">
    <header class="snippets-header">
        <input type="text" id="snip-search" placeholder="Buscar snippets..." class="search-bar" />
        <button id="btn-new-snip" class="btn btn-primary">+ Nuevo Snippet</button>
    </header>
    
    <div id="snippets-grid" class="masonry-grid">
        <!-- Snippets injected here -->
    </div>
    
    <!-- Modal -->
    <dialog id="snip-dialog" class="modal wide-modal">
        <form method="dialog" id="snip-form">
            <h3 id="snip-modal-title" style="margin-bottom:1rem; color: var(--color-text-main);">Snippet</h3>
            
            <div style="display:flex; flex-direction:column; gap:1rem;">
                <input type="text" id="snip-title" placeholder="Título del Snippet" class="input-dark">
                
                <select id="snip-lang" class="input-dark">
                    <option value="" disabled selected>Seleccionar Lenguaje</option>
                    <option value="Bash">Bash</option>
                    <option value="Python">Python</option>
                    <option value="JavaScript">JavaScript</option>
                    <option value="TypeScript">TypeScript</option>
                    <option value="HTML">HTML</option>
                    <option value="CSS">CSS</option>
                    <option value="SQL">SQL</option>
                    <option value="JSON">JSON</option>
                    <option value="YAML">YAML</option>
                    <option value="Markdown">Markdown</option>
                    <option value="Java">Java</option>
                    <option value="C++">C++</option>
                    <option value="C#">C#</option>
                    <option value="Go">Go</option>
                    <option value="Rust">Rust</option>
                    <option value="TEXT">Texto</option>
                </select>

                <textarea id="snip-code" placeholder="Código..." style="height:200px; font-family:'Fira Code', monospace;" class="input-dark"></textarea>
                <input type="text" id="snip-desc" placeholder="Breve descripción" class="input-dark">
                <input type="text" id="snip-tags" placeholder="Etiquetas (separadas por comas)" class="input-dark">
                
                <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem;">
                    <button id="btn-cancel-snip" type="button" class="btn btn-ghost">Cancelar</button>
                </div>
            </div>
        </form>
    </dialog>
</div>

<style>
    .snippets-container { padding: 2rem; height: 100%; overflow-y: auto; background: var(--color-bg-base); }
    .snippets-header { display: flex; gap: 1rem; margin-bottom: 2rem; max-width: 1000px; margin-left: auto; margin-right: auto;}
    
    /* Modal Override */
    .wide-modal { max-width: 600px !important; }
    
    /* Input Dark Override */
    .input-dark {
        background: var(--color-bg-card) !important;
        border: 1px solid var(--color-border) !important;
        color: var(--color-text-main) !important;
    }
    .input-dark::placeholder { color: var(--color-text-muted); }
    .input-dark:focus { border-color: var(--color-primary) !important; }

    .code-font { font-family: 'Fira Code', monospace; font-size: 0.9rem; }
</style>

<script>
    import { store } from '../lib/store.js';
    import { SnippetActions } from '../lib/actions/snippets.js';

    const grid = document.getElementById('snippets-grid');
    const search = document.getElementById('snip-search');
    const btnNew = document.getElementById('btn-new-snip');
    const dialog = document.getElementById('snip-dialog');
    const btnCancel = document.getElementById('btn-cancel-snip');
    
    // Inputs
    const iTitle = document.getElementById('snip-title');
    const iLang = document.getElementById('snip-lang');
    const iTags = document.getElementById('snip-tags');
    const iCode = document.getElementById('snip-code');
    const iDesc = document.getElementById('snip-desc');

    let activeAgendaId = null;
    let currentSnipId = null; // null = create mode
    let shouldSave = true; // Flag to control auto-save

    // Helper: Reset Modal
    function resetModal() {
        currentSnipId = null;
        shouldSave = true;
        iTitle.value = ''; iLang.value = ''; iCode.value = ''; iDesc.value = ''; iTags.value = '';
    }

    // Helper: Save current
    function saveCurrent() {
        if(!shouldSave) return; // Don't save if cancelled
        if(!activeAgendaId || !iTitle.value.trim()) return; // Don't save empty/invalid
        
        const data = {
            title: iTitle.value,
            language: iLang.value || 'TEXT',
            code: iCode.value,
            description: iDesc.value,
            tags: iTags.value.split(',').map(t=>t.trim()).filter(Boolean)
        };

        if(currentSnipId) {
            SnippetActions.updateSnippet(activeAgendaId, currentSnipId, data);
        } else {
            SnippetActions.createSnippet(activeAgendaId, data);
        }
    }

    btnNew.addEventListener('click', () => {
        resetModal();
        dialog.showModal();
    });

    // Cancel Button -> Discard
    btnCancel.addEventListener('click', () => {
        shouldSave = false; // Prevent auto-save
        dialog.close();
    });

    // Auto-save on click outside or normal close
    dialog.addEventListener('click', (e) => {
        if(e.target === dialog) {
            // Clicked outside -> Save & Close
            // (shouldSave is true by default reset)
            saveCurrent();
            dialog.close();
        }
    });

    // Also catch 'close' event? No, close event fires after dialog.close()
    // We handle save explicitly before closing in the click listeners.
    
    function render(state) {
        if (!state.activeAgendaId) return;
        activeAgendaId = state.activeAgendaId;

        const ws = state.workspaces.find(w => w.id === state.activeWorkspaceId);
        if (!ws) return;
        const agenda = ws.agendas.find(a => a.id === activeAgendaId);
        if (!agenda) return;

        const snippets = agenda.snippets || [];
        const filter = search.value.toLowerCase();
        
        const filtered = snippets.filter(s => 
            s.title.toLowerCase().includes(filter) || 
            (s.tags && s.tags.some(t => t.toLowerCase().includes(filter)))
        );

        grid.innerHTML = '';
        filtered.forEach(s => {
            const card = document.createElement('div');
            card.className = 'task-card-base animate-fade-in group'; 
            
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; pointer-events:none;">
                    <h4 style="font-weight:700; color:#f8fafc;">${s.title}</h4>
                    <span style="font-size:0.7rem; background:#334155; padding:2px 6px; border-radius:4px; color:#cbd5e1;">${s.language}</span>
                </div>
                <div style="background:#0f172a; padding:0.5rem; border-radius:6px; margin-bottom:0.5rem; position:relative;">
                     <pre style="margin:0; overflow-x:auto; font-family:'Fira Code', monospace; font-size:0.8rem; color:#a5b4fc; pointer-events:none;"><code>${escapeHtml(s.code)}</code></pre>
                     <button class="btn-copy" style="position:absolute; top:4px; right:4px; padding:2px 6px; font-size:0.7rem; background:#334155; border:none; color:white; border-radius:4px; cursor:pointer;">Copiar</button>
                </div>
                <p style="font-size:0.85rem; color:#94a3b8; margin-bottom:0.5rem; pointer-events:none;">${s.description}</p>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; pointer-events:none;">
                    ${(s.tags||[]).map(t => `<span style="font-size:0.7rem; color:#6366f1;">#${t}</span>`).join('')}
                </div>
                <div style="text-align:right; margin-top:0.5rem;">
                     <button class="btn-del-snip" style="color:#ef4444; background:none; border:none; cursor:pointer;">Eliminar</button>
                </div>
            `;
            
            // Edit interaction
            card.addEventListener('click', (e) => {
                if(e.target.closest('button')) return; 
                
                currentSnipId = s.id;
                shouldSave = true; // Enable save for edit mode
                iTitle.value = s.title;
                iLang.value = s.language;
                iTags.value = (s.tags||[]).join(', ');
                iCode.value = s.code;
                iDesc.value = s.description;
                dialog.showModal();
            });

            // Copy with feedback
            const copyBtn = card.querySelector('.btn-copy');
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                navigator.clipboard.writeText(s.code);
                
                const originalText = copyBtn.innerText;
                copyBtn.innerText = 'Copiado';
                copyBtn.style.background = '#059669'; 
                setTimeout(() => {
                    copyBtn.innerText = originalText;
                    copyBtn.style.background = '#334155';
                }, 1000);
            });
            
            // Delete
            card.querySelector('.btn-del-snip').addEventListener('click', (e) => {
               e.stopPropagation();
               if(confirm('¿Eliminar snippet?')) SnippetActions.deleteSnippet(activeAgendaId, s.id);
            });

            grid.appendChild(card);
        });
    }
    
    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    search.addEventListener('input', () => render(store.getState()));
    store.subscribe(render);
</script>
