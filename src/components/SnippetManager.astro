---
---
<div class="snippets-container">
    <div class="snippets-header">
        <div style="flex:1;">
            <input type="text" id="snip-search" class="input-dark input-lg" placeholder="Buscar snippets (título o #tag)..." style="width:100%; padding:1rem; border-radius:12px; font-size:1.1rem;">
        </div>
        <button id="btn-new-snip" class="btn btn-primary" style="padding:0 2rem; font-weight:700;">+ Nuevo Snippet</button>
    </div>

    <!-- Masonry Grid -->
    <div id="snippets-grid" class="masonry-grid">
        <!-- Snippet Cards rendered here -->
    </div>

    <!-- Create/Edit Modal -->
    <dialog id="snip-dialog" class="modal wide-modal">
        <div class="modal-wrapper">
             <header class="modal-header">
                <h3>Editor de Snippet</h3>
            </header>
            <div class="modal-body">
                <div style="display:flex; flex-direction:column; gap:1rem;">
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:1rem;">
                        <input id="snip-title" type="text" class="input-modal" placeholder="Título del snippet" />
                        <input id="snip-lang" type="text" class="input-modal" placeholder="Lenguaje (js, py, css...)" />
                    </div>
                    
                    <textarea id="snip-code" class="input-modal code-font" rows="12" placeholder="// Pega tu código aquí..."></textarea>
                    
                    <input id="snip-desc" type="text" class="input-modal" placeholder="Descripción breve (opcional)" />
                    <input id="snip-tags" type="text" class="input-modal" placeholder="Etiquetas separadas por coma (ej. react, hook, auth)" />
                </div>
            </div>
            <div style="padding: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button id="btn-cancel-snip" class="btn btn-ghost">Cancelar</button>
                <button id="btn-save-snip" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="snippet-confirm-modal" class="modal">
        <div class="modal-wrapper">
            <header class="modal-header">
                <h3 id="snippet-confirm-title">Confirmar Acción</h3>
            </header>
            <div class="modal-body">
                <p id="snippet-confirm-message" style="color:var(--color-text-main);">¿Estás seguro?</p>
            </div>
            <div style="padding: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button id="snippet-btn-confirm-cancel" class="btn btn-ghost">Cancelar</button>
                <button id="snippet-btn-confirm-ok" class="btn btn-primary btn-danger">Confirmar</button>
            </div>
        </div>
    </dialog>
</div>

<style>
    .snippets-container { 
        padding: 2rem; 
        height: 100%; 
        overflow-y: auto; 
        background: var(--color-bg-base); 
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .snippets-container::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */

    .masonry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        grid-auto-rows: max-content;
        gap: 1.5rem;
    }
    .snippets-header { display: flex; gap: 1rem; margin-bottom: 2rem; max-width: 1000px; margin-left: auto; margin-right: auto;}
    
    /* Modal Override */
    .wide-modal { max-width: 600px !important; }
    
    /* Modal Base Styles (Reuse from globally available or define locally) */
    dialog.modal {
        max-width: 500px; width: 90%; background: transparent; border: none; padding: 0;
        margin: auto;
    }
    dialog.modal::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .modal-wrapper {
        background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 16px; box-shadow: var(--shadow-hover); overflow: hidden;
    }
    .modal-header { padding: 1.5rem; background: var(--color-bg-elevated); border-bottom: 1px solid var(--color-border); }
    .modal-header h3 { margin: 0; color: var(--color-text-main); font-size: 1.25rem; }
    .modal-body { padding: 1.5rem; }

    /* Input Dark Override */
    .input-dark {
        background: var(--color-bg-card) !important;
        border: 1px solid var(--color-border) !important;
        color: var(--color-text-main) !important;
    }
    .input-dark::placeholder { color: var(--color-text-muted); }
    .input-dark:focus { border-color: var(--color-primary) !important; }

    .code-font { font-family: 'Fira Code', monospace; font-size: 0.9rem; }
</style>

<script>
    import { store } from '../lib/store.js';
    import { SnippetActions } from '../lib/actions/snippets.js';

    const grid = document.getElementById('snippets-grid');
    const search = document.getElementById('snip-search');
    const btnNew = document.getElementById('btn-new-snip');
    const dialog = document.getElementById('snip-dialog');
    const btnCancel = document.getElementById('btn-cancel-snip');
    const btnSave = document.getElementById('btn-save-snip');
    
    // Confirm Modal Refs
    const confirmModal = document.getElementById('snippet-confirm-modal');
    const confirmTitle = document.getElementById('snippet-confirm-title');
    const confirmMsg = document.getElementById('snippet-confirm-message');
    const btnConfirmOk = document.getElementById('snippet-btn-confirm-ok');
    const btnConfirmCancel = document.getElementById('snippet-btn-confirm-cancel');

    let onConfirmCallback = null;

    // Helper: Show Confirm
    function showConfirm(title, message, callback) {
        confirmTitle.innerText = title;
        confirmMsg.innerText = message;
        onConfirmCallback = callback;
        confirmModal.showModal();
    }
    
     function closeConfirm() {
        onConfirmCallback = null;
        confirmModal.close();
    }

    btnConfirmCancel.addEventListener('click', closeConfirm);

    btnConfirmOk.addEventListener('click', () => {
        if(onConfirmCallback) onConfirmCallback();
        closeConfirm();
    });
    
     // Close confirm on outside click
    confirmModal.addEventListener('click', (e) => {
        if(e.target === confirmModal) closeConfirm();
    });

    // Inputs
    const iTitle = document.getElementById('snip-title');
    const iLang = document.getElementById('snip-lang');
    const iTags = document.getElementById('snip-tags');
    const iCode = document.getElementById('snip-code');
    const iDesc = document.getElementById('snip-desc');

    let activeAgendaId = null;
    let currentSnipId = null; // null = create mode
    let shouldSave = true; // Flag to control auto-save

    // Helper: Reset Modal
    function resetModal() {
        currentSnipId = null;
        shouldSave = true;
        iTitle.value = ''; iLang.value = ''; iCode.value = ''; iDesc.value = ''; iTags.value = '';
    }

    // Helper: Save current
    function saveCurrent() {
        if(!shouldSave) return; // Don't save if cancelled
        if(!activeAgendaId || !iTitle.value.trim()) return; // Don't save empty/invalid
        
        const data = {
            title: iTitle.value,
            language: iLang.value || 'TEXT',
            code: iCode.value,
            description: iDesc.value,
            tags: iTags.value.split(',').map(t=>t.trim()).filter(Boolean)
        };

        if(currentSnipId) {
            SnippetActions.updateSnippet(activeAgendaId, currentSnipId, data);
        } else {
            SnippetActions.createSnippet(activeAgendaId, data);
        }
    }

    btnNew.addEventListener('click', () => {
        resetModal();
        dialog.showModal();
    });

    // Cancel Button -> Discard
    btnCancel.addEventListener('click', () => {
        shouldSave = false; // Prevent auto-save
        dialog.close();
    });

    // Save Button -> Manual Save
    btnSave.addEventListener('click', () => {
        // saveCurrent cheks shouldSave, so we leave it true
        saveCurrent();
        dialog.close();
    });

    // Auto-save on click outside or normal close
    dialog.addEventListener('click', (e) => {
        if(e.target === dialog) {
            // Clicked outside -> Save & Close
            // (shouldSave is true by default reset)
            saveCurrent();
            dialog.close();
        }
    });

    
    function render(state) {
        if (!state.activeAgendaId) return;
        activeAgendaId = state.activeAgendaId;

        const ws = state.workspaces.find(w => w.id === state.activeWorkspaceId);
        if (!ws) return;
        const agenda = ws.agendas.find(a => a.id === activeAgendaId);
        if (!agenda) return;

        const snippets = agenda.snippets || [];
        const filter = search.value.toLowerCase();
        
        const filtered = snippets.filter(s => 
            s.title.toLowerCase().includes(filter) || 
            (s.tags && s.tags.some(t => t.toLowerCase().includes(filter)))
        );

        grid.innerHTML = '';
        filtered.forEach(s => {
            const card = document.createElement('div');
            card.className = 'task-card-base animate-fade-in group'; 
            
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; pointer-events:none;">
                    <h4 style="font-weight:700; color:#f8fafc;">${s.title}</h4>
                    <span style="font-size:0.7rem; background:#334155; padding:2px 6px; border-radius:4px; color:#cbd5e1;">${s.language}</span>
                </div>
                <div style="background:#0f172a; padding:0.5rem; border-radius:6px; margin-bottom:0.5rem; position:relative; min-height: 2.5rem;">
                     <pre style="margin:0; overflow-x:auto; font-family:'Fira Code', monospace; font-size:0.8rem; color:#a5b4fc; pointer-events:none;"><code>${s.code && s.code.trim() ? escapeHtml(s.code) : '<span style="color: #64748b; font-style: italic;">// Sin código</span>'}</code></pre>
                     ${s.code && s.code.trim() ? `<button class="btn-copy" style="position:absolute; top:4px; right:4px; padding:2px 6px; font-size:0.7rem; background:#334155; border:none; color:white; border-radius:4px; cursor:pointer;">Copiar</button>` : ''}
                </div>
                <p style="font-size:0.85rem; color:#94a3b8; margin-bottom:0.5rem; pointer-events:none;">${s.description}</p>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; pointer-events:none;">
                    ${(s.tags||[]).map(t => `<span style="font-size:0.7rem; color:#6366f1;">#${t}</span>`).join('')}
                </div>
                <div style="text-align:right; margin-top:0.5rem;">
                     <button class="btn-del-snip" style="color:#ef4444; background:none; border:none; cursor:pointer;">Eliminar</button>
                </div>
            `;
            
            // Edit interaction
            card.addEventListener('click', (e) => {
                if(e.target.closest('button')) return; 
                
                currentSnipId = s.id;
                shouldSave = true; // Enable save for edit mode
                iTitle.value = s.title;
                iLang.value = s.language;
                iTags.value = (s.tags||[]).join(', ');
                iCode.value = s.code;
                iDesc.value = s.description;
                dialog.showModal();
            });

            // Copy with feedback
            const copyBtn = card.querySelector('.btn-copy');
            if(copyBtn) {
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    navigator.clipboard.writeText(s.code);
                    
                    const originalText = copyBtn.innerText;
                    copyBtn.innerText = 'Copiado';
                    copyBtn.style.background = '#059669'; 
                    setTimeout(() => {
                        copyBtn.innerText = originalText;
                        copyBtn.style.background = '#334155';
                    }, 1000);
                });
            }
            
            // Delete
            card.querySelector('.btn-del-snip').addEventListener('click', (e) => {
               e.stopPropagation();
               showConfirm('Eliminar Snippet', '¿Estás seguro de que deseas eliminar este snippet?', () => {
                   SnippetActions.deleteSnippet(activeAgendaId, s.id);
               });
            });

            grid.appendChild(card);
        });
    }
    
    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    search.addEventListener('input', () => render(store.getState()));
    store.subscribe(render);
</script>
