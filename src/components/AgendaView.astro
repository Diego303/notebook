---
// AgendaView.astro
import NoteEditor from './NoteEditor.astro';
import TaskBoard from './TaskBoard.astro';
import Journal from './Journal.astro';
import SnippetManager from './SnippetManager.astro';
import MetricsDashboard from './MetricsDashboard.astro';
---

<div class="agenda-view-container">
    <!-- 1. Agenda Grid View (Dashboard) -->
    <div id="agenda-dashboard" class="centered-view animate-fade-in hidden">
        <div class="ws-intro">
             <h1 id="workspace-title-display">Workspace</h1>
             <p class="subtitle">Selecciona una agenda para enfocar</p>
        </div>
        
        <div class="actions-bar">
             <button id="btn-back-ws" class="btn btn-ghost">‚Üê Workspaces</button>
             <div class="divider"></div>
             <button id="btn-create-agenda" class="btn btn-primary">
                <span class="icon">+</span> Nueva Agenda
             </button>
        </div>

        <div id="agenda-grid" class="grid-cards">
            <!-- Agendas -->
        </div>
        
        <p id="agenda-empty-msg" class="empty-state hidden">A√∫n no hay agendas. ¬°Comienza una nueva!</p>
    </div>

    <!-- 2. Active Agenda Detail View -->
    <div id="agenda-detail" class="detail-layout hidden">
        <header class="detail-header">
            <div class="header-left">
                <button id="btn-close-agenda" class="btn btn-ghost btn-sm">‚Üê Volver</button>
                <div class="divider-vertical"></div>
                <h2 id="active-agenda-title">Nombre Agenda</h2>
            </div>
            <div class="header-right">
                <nav class="nav-tabs">
                     <button class="nav-tab active" data-target="notes">Notas</button>
                     <button class="nav-tab" data-target="tasks">Tasks</button>
                     <button class="nav-tab" data-target="journal">Journal</button>
                     <button class="nav-tab" data-target="snippets">Snippets</button>
                     <button class="nav-tab" data-target="metrics">M√©tricas</button>
                </nav>
            </div>
            <div class="header-actions">
                 <button id="btn-edit-agenda" class="btn btn-ghost btn-sm" title="Renombrar Agenda">‚úèÔ∏è</button>
                 <button id="btn-delete-agenda" class="btn btn-ghost btn-sm btn-icon-danger" title="Eliminar Agenda">üóëÔ∏è</button>
            </div>
        </header>

        <main class="detail-content">
             <div id="view-notes" class="view-pane">
                 <NoteEditor />
             </div>
             <div id="view-tasks" class="view-pane hidden">
                 <TaskBoard />
             </div>
             <div id="view-journal" class="view-pane hidden">
                 <Journal />
             </div>
             <div id="view-snippets" class="view-pane hidden">
                 <SnippetManager />
             </div>
             <div id="view-metrics" class="view-pane hidden">
                 <MetricsDashboard />
             </div>
        </main>
    </div>

    <!-- Modal Create/Rename Agenda -->
    <dialog id="agenda-dialog" class="modal">
        <form method="dialog">
            <h2 id="agenda-dialog-title">Nueva Agenda</h2>
            <input type="text" id="agenda-name-input" placeholder="ej. Planificaci√≥n Q4, Proyecto Alfa" required autocomplete="off" />
            <div class="modal-actions">
                <button value="cancel" class="btn btn-ghost" formnovalidate>Cancelar</button>
                <button id="btn-save-agenda" value="save" class="btn btn-primary">Crear Agenda</button>
            </div>
        </form>
    </dialog>

    <!-- Modal Delete Agenda -->
    <dialog id="delete-agenda-dialog" class="modal">
        <form method="dialog">
            <h2>¬øEliminar Agenda?</h2>
            <p style="margin-bottom: 1.5rem; color: var(--color-text-muted);">Esta acci√≥n borrar√° todas las notas, tareas, journals y m√©tricas de esta agenda.</p>
            <div class="modal-actions">
                <button value="cancel" class="btn btn-ghost">Cancelar</button>
                <button id="btn-confirm-delete-agenda" value="delete" class="btn btn-danger">Eliminar Agenda</button>
            </div>
        </form>
    </dialog>
</div>

<style>
/* Layouts */
.agenda-view-container {
    width: 100%;
    height: 100%;
}

/* Modal Styling */
.modal {
    margin: auto;
    padding: 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: 16px;
    background: var(--color-bg-card);
    box-shadow: var(--shadow-card);
    max-width: 400px;
    width: 90%;
    color: var(--color-text-main);
}

.modal::backdrop {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

.modal[open] {
    animation: fade-in 0.2s ease-out;
}

.modal h2 {
    color: var(--color-text-main);
}

/* Dashboard Styles (Reusing generic centered-view/grid-cards from global, adding specific override if needed) */

/* Detail View Styles */
.detail-layout {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: var(--color-bg-base);
}

.detail-header {
    height: 60px;
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    z-index: 10;
}

.header-left, .header-right {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.divider-vertical {
    width: 1px;
    height: 20px;
    background: var(--color-border);
}

#active-agenda-title {
    font-size: 1.125rem;
    font-weight: 600;
}

.nav-tabs {
    display: flex;
    gap: var(--spacing-xs);
    background: var(--color-bg-base);
    padding: 4px;
    border-radius: var(--radius-md);
}

.nav-tab {
    border: none;
    background: transparent;
    padding: 0.4rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.nav-tab:hover {
    color: var(--color-text-main);
}

.nav-tab.active {
    background: var(--color-bg-card);
    color: var(--color-primary);
    box-shadow: var(--shadow-sm);
}

.detail-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.view-pane {
    width: 100%;
    height: 100%;
}

.placeholder-pane {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--color-text-muted);
}

/* Header Actions */
.header-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon-danger:hover {
    color: var(--color-danger);
    background: rgba(239, 68, 68, 0.1);
}

/* Responsive Agenda View */
@media (max-width: 768px) {
    .detail-header {
        height: auto;
        flex-direction: column;
        align-items: flex-start;
        padding: var(--spacing-sm) var(--spacing-md);
        gap: var(--spacing-sm);
    }

    .header-left {
        width: 100%;
        justify-content: space-between;
    }

    .header-right {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 4px;
        /* Hide scrollbar for cleaner look */
        scrollbar-width: none; 
    }
    
    .nav-tabs {
        width: max-content; /* Allow scrolling */
    }

    .detail-content {
        padding-top: 0;
    }
}
</style>

<script>
  import { store } from '../lib/store.js';
  import { AgendaActions } from '../lib/actions/agendas.js';
  import { WorkspaceActions } from '../lib/actions/workspaces.js';

  // Elements
  const dashboard = document.getElementById('agenda-dashboard');
  const detail = document.getElementById('agenda-detail');
  const wsTitle = document.getElementById('workspace-title-display');
  const agendaGrid = document.getElementById('agenda-grid');
  const emptyMsg = document.getElementById('agenda-empty-msg');
  
  const activeTitle = document.getElementById('active-agenda-title');
  
  // Buttons
  const btnCreate = document.getElementById('btn-create-agenda');
  const btnBackWs = document.getElementById('btn-back-ws');
  const btnCloseAgenda = document.getElementById('btn-close-agenda');
  
  const btnEditAgenda = document.getElementById('btn-edit-agenda');
  const btnDeleteAgenda = document.getElementById('btn-delete-agenda');
  
  // Modals
  const dialog = document.getElementById('agenda-dialog');
  const nameInput = document.getElementById('agenda-name-input');
  const btnSave = document.getElementById('btn-save-agenda');
  const dialogTitle = document.getElementById('agenda-dialog-title');

  const deleteDialog = document.getElementById('delete-agenda-dialog');
  const confirmDeleteBtn = document.getElementById('btn-confirm-delete-agenda');

  // State
  let isEditing = false;

  // Logic
  function render(state) {
      const activeWsId = state.activeWorkspaceId;
      const activeAgendaId = state.activeAgendaId;
      
      // Safety
      if (!activeWsId) return; 
      const ws = state.workspaces.find(w => w.id === activeWsId);
      if (!ws) return;

      // Update basic info
      wsTitle.innerText = ws.name;

      if (activeAgendaId) {
          // SHOW DETAIL
          const agenda = ws.agendas.find(a => a.id === activeAgendaId);
          if (agenda) {
              dashboard.classList.add('hidden');
              detail.classList.remove('hidden');
              activeTitle.innerText = agenda.name;
          } else {
              // Agenda missing?
              AgendaActions.selectAgenda(null);
          }
      } else {
          // SHOW DASHBOARD (GRID)
          detail.classList.add('hidden');
          dashboard.classList.remove('hidden');
          
          // Render Grid
          const agendas = ws.agendas || [];
          agendaGrid.innerHTML = '';
          
          if (agendas.length === 0) {
              emptyMsg.classList.remove('hidden');
          } else {
              emptyMsg.classList.add('hidden');
              agendas.forEach(ag => {
                  const card = document.createElement('div');
                  card.className = 'card animate-fade-in';
                  card.innerHTML = `
                      <h3 style="font-size: 1.25rem; font-weight: 600;">${ag.name}</h3>
                      <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-top: 0.5rem;">
                          ${ag.notes?.length || 0} notas ‚Ä¢ ${ag.tasks?.length || 0} tareas
                      </p>
                      <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-top: 0.2rem;">
                          ${ag.journals?.length || (ag.journal ? 1 : 0)} journals ‚Ä¢ ${ag.snippets?.length || 0} snippets
                      </p>
                  `;
                  card.addEventListener('click', () => AgendaActions.selectAgenda(ag.id));
                  agendaGrid.appendChild(card);
              });
          }
      }
  }

  // Navigation Listeners
  btnBackWs.addEventListener('click', () => {
      WorkspaceActions.selectWorkspace(null);
  });
  
  btnCloseAgenda.addEventListener('click', () => {
      AgendaActions.selectAgenda(null);
  });
  
  // Create / Edit Agenda Logic
  function openAgendaModal(editMode = false) {
      isEditing = editMode;
      nameInput.value = '';
      
      if (editMode) {
          dialogTitle.innerText = 'Renombrar Agenda';
          btnSave.innerText = 'Renombrar';
          // Pre-fill name
          const state = store.getState();
          const ws = state.workspaces.find(w => w.id === state.activeWorkspaceId);
          const agenda = ws?.agendas.find(a => a.id === state.activeAgendaId);
          if(agenda) nameInput.value = agenda.name;
      } else {
          dialogTitle.innerText = 'Nueva Agenda';
          btnSave.innerText = 'Crear Agenda';
      }
      
      dialog.showModal();
  }

  btnCreate.addEventListener('click', () => openAgendaModal(false));
  btnEditAgenda.addEventListener('click', () => openAgendaModal(true));

  // Edit / Save Confirm
  btnSave.addEventListener('click', (e) => {
      e.preventDefault();
      const val = nameInput.value;
      if (val) {
          if (isEditing) {
              const state = store.getState();
              if (state.activeAgendaId) {
                  AgendaActions.renameAgenda(state.activeAgendaId, val);
              }
          } else {
              AgendaActions.createAgenda(val);
          }
          dialog.close();
      }
  });

  // Enter to submit
  nameInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') {
          e.preventDefault();
          btnSave.click();
      }
  });
  
  // Delete Agenda
  btnDeleteAgenda.addEventListener('click', () => {
      deleteDialog.showModal();
  });

  confirmDeleteBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const state = store.getState();
      if(state.activeAgendaId) {
          AgendaActions.deleteAgenda(state.activeAgendaId);
          AgendaActions.selectAgenda(null); // Go back to dashboard
      }
      deleteDialog.close();
  });

  // Tab Switching
  const tabs = document.querySelectorAll('.nav-tab');
  const panes = document.querySelectorAll('.view-pane');
  tabs.forEach(tab => {
      tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          panes.forEach(p => p.classList.add('hidden'));
          document.getElementById(`view-${target}`).classList.remove('hidden');
      });
  });

  store.subscribe(render);
</script>
